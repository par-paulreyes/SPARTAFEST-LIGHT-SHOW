<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event LED Light - User</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #lightScreen {
            width: 100vw;
            height: 100vh;
            background: #000;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* 3-Light Pattern Display */
        .pattern-lights {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            gap: 50px;
            z-index: 10;
        }
        
        .pattern-light {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: #000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
        }
        
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #connectionStatus {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            margin-right: 10px;
            display: inline-block;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        #connectionStatus.connected {
            background: #44ff44;
            box-shadow: 0 0 10px rgba(68, 255, 68, 0.5);
        }
        
        .device-info {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .admin-link {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
            color: white;
            font-size: 13px;
            opacity: 0.7;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-link:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .effect-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .effect-indicator.visible {
            opacity: 1;
        }
        
        /* Enhanced Animations */
        .strobe {
            animation: strobe 0.1s infinite;
        }
        
        .pulse {
            animation: pulse 1s ease-in-out infinite;
        }
        
        .fade {
            animation: fade 2s ease-in-out infinite;
        }
        
        .wave {
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .rainbow {
            animation: rainbow 3s linear infinite;
        }
        
        .flash {
            animation: flash 0.3s ease-out;
        }
        
        /* Pattern-specific animations */
        .sequence-1 { animation-delay: 0s; }
        .sequence-2 { animation-delay: 0.3s; }
        .sequence-3 { animation-delay: 0.6s; }
        
        .alternate-odd { animation: pulse 1s ease-in-out infinite; }
        .alternate-even { animation: pulse 1s ease-in-out infinite reverse; }
        
        .chase { animation: wave 1s ease-in-out infinite; }
        
        @keyframes strobe {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        
        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }
        
        @keyframes wave {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes flash {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .loading {
            text-align: center;
            opacity: 0.7;
            font-size: 1.2em;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Beat effect styles */
        .beat-flash {
            animation: beatFlash 0.2s ease-out;
        }
        
        @keyframes beatFlash {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.05);
                filter: brightness(1.5);
            }
            100% { 
                transform: scale(1);
                filter: brightness(1);
            }
        }
        
        /* Emergency mode */
        .emergency {
            background: #000 !important;
            opacity: 0 !important;
        }
        
        @media (max-width: 768px) {
            .pattern-light {
                width: 120px;
                height: 120px;
                font-size: 2em;
            }
            
            .pattern-lights {
                gap: 30px;
                flex-direction: column;
            }
            
            #status, .device-info {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
        @keyframes fadeInStandby {
            0% {
                opacity: 0;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Logo pop/bounce animation */
        @keyframes logoPop {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .standby-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 999;
            padding: 20px;
            flex-direction: column;
            line-height: 1.5;
            animation: fadeInStandby 1s ease-out forwards;
        }

        .standby-logo {
            max-width: 400px;
            margin-bottom: 20px;
            animation: logoPop 0.8s ease-out;
        }

        #status.hidden,
        .device-info.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

    </style>
</head>
<body>
    <div id="lightScreen">
        <div id="status">
            <span id="connectionStatus"></span>
            <span id="statusText">Connecting...</span>
        </div>
        
        <div class="device-info" id="deviceInfo">
            Device ID: <span id="deviceId">Loading...</span><br>
            Last Update: <span id="lastUpdate">Never</span>
        </div>
        
        <div class="effect-indicator" id="effectIndicator">
            Current Effect: <span id="currentEffect">None</span>
        </div>

        <div class="loading" id="loadingMessage">
            Loading...
        </div>
        
        <!-- 3-Light Pattern Display -->
        <div class="pattern-lights" id="patternLights">
            <div class="pattern-light" id="light1">1</div>
            <div class="pattern-light" id="light2">2</div>
            <div class="pattern-light" id="light3">3</div>
        </div>

        <div id="standbyScreen" class="standby-screen">

            <img src="LOGO.png" alt="Spartafest Logo" class="standby-logo" /><br>
            Welcome to Spartafest 2025 Light Show<br>
            Please wait for event commands...
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration - REPLACE WITH YOUR CONFIG
        const firebaseConfigs = [
            {
                "apiKey": "AIzaSyCHkiw5mKCQtauICu10DU3_omvcgmUbmec",
                "authDomain": "spartafest-light-show.firebaseapp.com",
                "projectId": "spartafest-light-show",
                "storageBucket": "spartafest-light-show.firebasestorage.app",
                "messagingSenderId": "438044433117",
                "appId": "1:438044433117:web:523ae33d8bf9f2131ed934"
            },
            {
                "apiKey": "AIzaSyBLTAL6XGY3we3h59oS6l7mqUiQzBn8H0M",
                "authDomain": "spartafest-light-show-f9608.firebaseapp.com",
                "projectId": "spartafest-light-show-f9608",
                "storageBucket": "spartafest-light-show-f9608.firebasestorage.app",
                "messagingSenderId": "970442612141",
                "appId": "1:970442612141:web:8e67654abfba5e379f5524"
            },
            {
                "apiKey": "AIzaSyB8kIXsZTDWLv3sOU7oXxKGRBtFc0ZXnzU",
                "authDomain": "spartafest-light-show-2fc17.firebaseapp.com",
                "projectId": "spartafest-light-show-2fc17",
                "storageBucket": "spartafest-light-show-2fc17.firebasestorage.app",
                "messagingSenderId": "575025203672",
                "appId": "1:575025203672:web:3e33fc83b8851c681b0aad"
            },
            {
                "apiKey": "AIzaSyCRCeiJ-LEyEH8wHXf3Eh92whKj0OuEMnw",
                "authDomain": "spartafest-light-show-d5bd1.firebaseapp.com",
                "projectId": "spartafest-light-show-d5bd1",
                "storageBucket": "spartafest-light-show-d5bd1.firebasestorage.app",
                "messagingSenderId": "221806972239",
                "appId": "1:221806972239:web:f595dcd3dec3ff0c0e893a"
            },
            {
                "apiKey": "AIzaSyCNYbIGLAhF1PawsoTFYjQGn9LaofKbKc0",
                "authDomain": "spartafest-light-show-34048.firebaseapp.com",
                "projectId": "spartafest-light-show-34048",
                "storageBucket": "spartafest-light-show-34048.firebasestorage.app",
                "messagingSenderId": "86595145364",
                "appId": "1:86595145364:web:32854f60d2c2bce41a6e81"
            },
            {
                "apiKey": "AIzaSyDBNf_L7pFDzhy-4c814VenF5mcoN9E7d4",
                "authDomain": "spartafest-light-show-511b5.firebaseapp.com",
                "projectId": "spartafest-light-show-511b5",
                "storageBucket": "spartafest-light-show-511b5.firebasestorage.app",
                "messagingSenderId": "219110318684",
                "appId": "1:219110318684:web:312693a8d03cbd7b6afc99"
            },
            {
                "apiKey": "AIzaSyAmmex08U_3h67_j6tLxB6Y97pBrUxoZgU",
                "authDomain": "spartafest-light-show-aca73.firebaseapp.com",
                "projectId": "spartafest-light-show-aca73",
                "storageBucket": "spartafest-light-show-aca73.firebasestorage.app",
                "messagingSenderId": "378962049746",
                "appId": "1:378962049746:web:b028618bc971d6397bcb0b"
            },
            {
                "apiKey": "AIzaSyCx24SxXOrbZN_KngbZt1Mzvqyk1P_sbrc",
                "authDomain": "spartafest-light-show-caa4b.firebaseapp.com",
                "projectId": "spartafest-light-show-caa4b",
                "storageBucket": "spartafest-light-show-caa4b.firebasestorage.app",
                "messagingSenderId": "98785134551",
                "appId": "1:98785134551:web:d3f9fae2650cc9cef1ed92"
            },
            {
                "apiKey": "AIzaSyBeWaotNNd24V0gJBkdm1zH1ReGUM7rL7g",
                "authDomain": "login-6bf6c.firebaseapp.com",
                "projectId": "login-6bf6c",
                "storageBucket": "login-6bf6c.firebasestorage.app",
                "messagingSenderId": "584216397876",
                "appId": "1:584216397876:web:c2a51aee9eadf6f1386261"
            },
            {
                "apiKey": "AIzaSyBFXDihFCY2ujjCUnfQCBhSLb6CYZhdZ18",
                "authDomain": "spartafest-light-show-c857a.firebaseapp.com",
                "projectId": "spartafest-light-show-c857a",
                "storageBucket": "spartafest-light-show-c857a.firebasestorage.app",
                "messagingSenderId": "526741058778",
                "appId": "1:526741058778:web:0d7b0d5ea2fbefcebaa1e3"
            },
            {
                "apiKey": "AIzaSyAc7KcsurTG5aUZiQoY3oXs0NJ6eD1C_8k",
                "authDomain": "spartafest-light-show-2.firebaseapp.com",
                "projectId": "spartafest-light-show-2",
                "storageBucket": "spartafest-light-show-2.firebasestorage.app",
                "messagingSenderId": "891237947797",
                "appId": "1:891237947797:web:263d00a12cf626817f7e9c"
            },
            {
                "apiKey": "AIzaSyB8CRVVHoco8Eo2Kgnivz4V_L2Xl24Fq7Q",
                "authDomain": "spartafest-light-show-3.firebaseapp.com",
                "projectId": "spartafest-light-show-3",
                "storageBucket": "spartafest-light-show-3.firebasestorage.app",
                "messagingSenderId": "739528906805",
                "appId": "1:739528906805:web:8ee4fc9d7eacb976a2f97c"
            },
            {
                "apiKey": "AIzaSyDxxsbxCvSbu3FdmZf2wrfMSc3CbOX2Z5A",
                "authDomain": "spartafest-light-show-73925.firebaseapp.com",
                "projectId": "spartafest-light-show-73925",
                "storageBucket": "spartafest-light-show-73925.firebasestorage.app",
                "messagingSenderId": "950212727438",
                "appId": "1:950212727438:web:5d40e97d0a087cc6c26fdf"
            },
            {
                "apiKey": "AIzaSyDrJtVcWcrNQISQIUE09tVdG4CNgKKdWUU",
                "authDomain": "spartafest-light-show-1.firebaseapp.com",
                "projectId": "spartafest-light-show-1",
                "storageBucket": "spartafest-light-show-1.firebasestorage.app",
                "messagingSenderId": "824918389420",
                "appId": "1:824918389420:web:5f9670a7baade372a16509"
            },
            {
                "apiKey": "AIzaSyA-Os8fVgNOgnw_oY9bvjsHMjAEm7f9ab0",
                "authDomain": "spartafest-light-show-5.firebaseapp.com",
                "projectId": "spartafest-light-show-5",
                "storageBucket": "spartafest-light-show-5.firebasestorage.app",
                "messagingSenderId": "72451860916",
                "appId": "1:72451860916:web:3f7b859be5ec771ca6aae1"
            },
            {
                "apiKey": "AIzaSyACAx5p0oXSlyZX6813_QDnIvXwNMNHFFE",
                "authDomain": "spartafest-light-show-6.firebaseapp.com",
                "projectId": "spartafest-light-show-6",
                "storageBucket": "spartafest-light-show-6.firebasestorage.app",
                "messagingSenderId": "620027996670",
                "appId": "1:620027996670:web:7474757f52bcfc6e5f38af"
            },
            {
                "apiKey": "AIzaSyDg-2_cq5dyZed3GI4mLOR5Tb1-lk6dUSg",
                "authDomain": "spartafest-light-show-7.firebaseapp.com",
                "projectId": "spartafest-light-show-7",
                "storageBucket": "spartafest-light-show-7.firebasestorage.app",
                "messagingSenderId": "830383004522",
                "appId": "1:830383004522:web:ca701f35fee5cad5956313"
            },
            {
                "apiKey": "AIzaSyC17oKO54nAnXbsxW5LUwdJve9A0DIMJyg",
                "authDomain": "spartafest-light-show-682f1.firebaseapp.com",
                "projectId": "spartafest-light-show-682f1",
                "storageBucket": "spartafest-light-show-682f1.firebasestorage.app",
                "messagingSenderId": "1010757733582",
                "appId": "1:1010757733582:web:d10784526f69ecd5a0149f"
            },
            {
                "apiKey": "AIzaSyCJw8YcpQCvurFjKlo175ZH_rp_d5X937k",
                "authDomain": "spartafest-light-show-9.firebaseapp.com",
                "projectId": "spartafest-light-show-9",
                "storageBucket": "spartafest-light-show-9.firebasestorage.app",
                "messagingSenderId": "114098478169",
                "appId": "1:114098478169:web:eba7b2e72507374cb1e548"
            },
            {
                "apiKey": "AIzaSyA6JsCx0P0VlN_w33PsQef5gogB6LYkLd8",
                "authDomain": "spartafest-light-show-10.firebaseapp.com",
                "projectId": "spartafest-light-show-10",
                "storageBucket": "spartafest-light-show-10.firebasestorage.app",
                "messagingSenderId": "304579628364",
                "appId": "1:304579628364:web:270e8fba53df42c71c13e9"
            },
            {
                "apiKey": "AIzaSyBjL0yx6xNCnwJfjFwJihKzdqPPWfos-Gk",
                "authDomain": "spartafest-light-show-11.firebaseapp.com",
                "projectId": "spartafest-light-show-11",
                "storageBucket": "spartafest-light-show-11.firebasestorage.app",
                "messagingSenderId": "647501946356",
                "appId": "1:647501946356:web:728a4d1def8ce838b32da1"
            },
            {
                "apiKey": "AIzaSyAn2eSRr5xVSRdpifi7kwEiUTiE_jjtrD4",
                "authDomain": "spartafest-light-show-1-51360.firebaseapp.com",
                "projectId": "spartafest-light-show-1-51360",
                "storageBucket": "spartafest-light-show-1-51360.firebasestorage.app",
                "messagingSenderId": "473571829499",
                "appId": "1:473571829499:web:d3793758c8508454f2b25e"
            },
            {
                "apiKey": "AIzaSyC6XnRnbtAbLJS9cGVanzPufejzwTuzmnE",
                "authDomain": "spartafest-light-show-2-d5a6c.firebaseapp.com",
                "projectId": "spartafest-light-show-2-d5a6c",
                "storageBucket": "spartafest-light-show-2-d5a6c.firebasestorage.app",
                "messagingSenderId": "842825346224",
                "appId": "1:842825346224:web:68f54e5e59a0a4aa48df75"
            },
            {
                "apiKey": "AIzaSyC5y8m5UhwopnB0tvKE3tMLzrN6y8FHSDA",
                "authDomain": "spartafest-light-show-3-7b3fa.firebaseapp.com",
                "projectId": "spartafest-light-show-3-7b3fa",
                "storageBucket": "spartafest-light-show-3-7b3fa.firebasestorage.app",
                "messagingSenderId": "627770503337",
                "appId": "1:627770503337:web:d0774e7f0b9cd3a0a339b8"
            },
            {
                "apiKey": "AIzaSyAY5yxXE4La2WYVbae7okte_y3OyEaaN84",
                "authDomain": "spartafest-light-show-4.firebaseapp.com",
                "projectId": "spartafest-light-show-4",
                "storageBucket": "spartafest-light-show-4.firebasestorage.app",
                "messagingSenderId": "28051173128",
                "appId": "1:28051173128:web:8dfca1edffdb6f3c68c6bd"
            },
            {
                "apiKey": "AIzaSyBu1jMonN2D8mZms343Ppzgiw95evGn3mI",
                "authDomain": "spartafest-light-show-5-334d8.firebaseapp.com",
                "projectId": "spartafest-light-show-5-334d8",
                "storageBucket": "spartafest-light-show-5-334d8.firebasestorage.app",
                "messagingSenderId": "51601270422",
                "appId": "1:51601270422:web:66e9d0a542936249b384b7"
            },
            {
                "apiKey": "AIzaSyC4d3lZX2804-5ArYgizmqtXBD7AN1yhYs",
                "authDomain": "spartafest-light-show-67fc1.firebaseapp.com",
                "projectId": "spartafest-light-show-67fc1",
                "storageBucket": "spartafest-light-show-67fc1.firebasestorage.app",
                "messagingSenderId": "382252956072",
                "appId": "1:382252956072:web:c873c00b9776631305059d"
            },
            {
                "apiKey": "AIzaSyCCRIlryDzqN9nbLzDK1pNGrNQAeWT8qUE",
                "authDomain": "spartafest-light-show-7-5bf5d.firebaseapp.com",
                "projectId": "spartafest-light-show-7-5bf5d",
                "storageBucket": "spartafest-light-show-7-5bf5d.firebasestorage.app",
                "messagingSenderId": "321620575364",
                "appId": "1:321620575364:web:5ba42368ce1900d6af6ed1"
            },
            {
                "apiKey": "AIzaSyBfrcY8Oq1av2dW0Zlf24_PNHj_ZXMceR4",
                "authDomain": "spartafest-light-show-2f818.firebaseapp.com",
                "projectId": "spartafest-light-show-2f818",
                "storageBucket": "spartafest-light-show-2f818.firebasestorage.app",
                "messagingSenderId": "442176875751",
                "appId": "1:442176875751:web:8fa0b815647a5dd56d4642"
            },
            {
                "apiKey": "AIzaSyA2hTA_G8EWzjzeQkvqwlOkJv29fjDBmyQ",
                "authDomain": "spartafest-light-show-9-a5ddb.firebaseapp.com",
                "projectId": "spartafest-light-show-9-a5ddb",
                "storageBucket": "spartafest-light-show-9-a5ddb.firebasestorage.app",
                "messagingSenderId": "97179297135",
                "appId": "1:97179297135:web:6512ad907904fd39cf749a"
            },
            {
                "apiKey": "AIzaSyCd_yyCCWYpns9d5XTjH-15yz-1HB6HXis",
                "authDomain": "spartafest-light-show-10-cb1ac.firebaseapp.com",
                "projectId": "spartafest-light-show-10-cb1ac",
                "storageBucket": "spartafest-light-show-10-cb1ac.firebasestorage.app",
                "messagingSenderId": "400526619561",
                "appId": "1:400526619561:web:091f7c76319d822fbd0ab8"
            },
            {
                "apiKey": "AIzaSyCjj4ITm6AECBp7rwYZYV2HSJp3ar79AMI",
                "authDomain": "spartafest-light-show-1-efdc9.firebaseapp.com",
                "projectId": "spartafest-light-show-1-efdc9",
                "storageBucket": "spartafest-light-show-1-efdc9.firebasestorage.app",
                "messagingSenderId": "378487304704",
                "appId": "1:378487304704:web:f1fd1156f03dc8213ddee5"
            },
            {
                "apiKey": "AIzaSyAYOwdRLSYBfA2K161GZVfHh7ngQUxmUQU",
                "authDomain": "spartafest-light-show-3-f5bac.firebaseapp.com",
                "projectId": "spartafest-light-show-3-f5bac",
                "storageBucket": "spartafest-light-show-3-f5bac.firebasestorage.app",
                "messagingSenderId": "979955640966",
                "appId": "1:979955640966:web:89048342ecfb672d4bff07"
            },
            {
                "apiKey": "AIzaSyD_ahlxz2tretunnJaZ749Te8s_s6nmx0Q",
                "authDomain": "spartafest-light-show-2-7d915.firebaseapp.com",
                "projectId": "spartafest-light-show-2-7d915",
                "storageBucket": "spartafest-light-show-2-7d915.firebasestorage.app",
                "messagingSenderId": "1064352295909",
                "appId": "1:1064352295909:web:1fcefae484b6ecb7c35d0c"
            },
            {
                "apiKey": "AIzaSyDXL7iSdXrP0WEl-dX8oMkd5vWk7BExnrI",
                "authDomain": "spartafest-light-show-4-8594e.firebaseapp.com",
                "projectId": "spartafest-light-show-4-8594e",
                "storageBucket": "spartafest-light-show-4-8594e.firebasestorage.app",
                "messagingSenderId": "302967657276",
                "appId": "1:302967657276:web:23cefb786ccbc59acc0439"
            },
            {
                "apiKey": "AIzaSyDMmcGsDP8ZJjgzdUU0vjXpxtFR9H87BT0",
                "authDomain": "spartafest-light-show-5-e7320.firebaseapp.com",
                "projectId": "spartafest-light-show-5-e7320",
                "storageBucket": "spartafest-light-show-5-e7320.firebasestorage.app",
                "messagingSenderId": "637399487911",
                "appId": "1:637399487911:web:865f8defc7d0b18c385282"
            },
            {
                "apiKey": "AIzaSyDfsfbiS_V9hhWkwTynD6n2pBzs41O5J3Q",
                "authDomain": "spartafest-light-show-6-51346.firebaseapp.com",
                "projectId": "spartafest-light-show-6-51346",
                "storageBucket": "spartafest-light-show-6-51346.firebasestorage.app",
                "messagingSenderId": "600885866546",
                "appId": "1:600885866546:web:4dea8145756463a1f08c2b"
            },
            {
                "apiKey": "AIzaSyD8hHnPJ2EZttUiciWXe2Df42w6tWPK4qA",
                "authDomain": "spartafest-light-show-8.firebaseapp.com",
                "projectId": "spartafest-light-show-8",
                "storageBucket": "spartafest-light-show-8.firebasestorage.app",
                "messagingSenderId": "175029137801",
                "appId": "1:175029137801:web:ca04c962f9b91469067158"
            },
            {
                "apiKey": "AIzaSyBptkDkLDlk1BqNGInN7KYsCyfAXhlRDKo",
                "authDomain": "spartafest-light-show-7-d0a54.firebaseapp.com",
                "projectId": "spartafest-light-show-7-d0a54",
                "storageBucket": "spartafest-light-show-7-d0a54.firebasestorage.app",
                "messagingSenderId": "370501194624",
                "appId": "1:370501194624:web:763d5469d34ca149586765"
            },
            {
                "apiKey": "AIzaSyAgM1bFx-NYM_R3575PKmt7xmsd8KzWC0M",
                "authDomain": "spartafest-light-show-9-a074a.firebaseapp.com",
                "projectId": "spartafest-light-show-9-a074a",
                "storageBucket": "spartafest-light-show-9-a074a.firebasestorage.app",
                "messagingSenderId": "753013919671",
                "appId": "1:753013919671:web:5f3320e45222271b96e232"
            },
            {
                "apiKey": "AIzaSyBr08MaX1vouI6h9qrNvBOeDR4P5dBp8LA",
                "authDomain": "spartafest-light-show-10-6206d.firebaseapp.com",
                "projectId": "spartafest-light-show-10-6206d",
                "storageBucket": "spartafest-light-show-10-6206d.firebasestorage.app",
                "messagingSenderId": "884857746855",
                "appId": "1:884857746855:web:1128d56981665b79b57282"
            },
            {
                "apiKey": "AIzaSyD9V82WvV2m7jZbjpKomZQzZAO_j4PcgxM",
                "authDomain": "spartafest-light-show-11-9da2c.firebaseapp.com",
                "projectId": "spartafest-light-show-11-9da2c",
                "storageBucket": "spartafest-light-show-11-9da2c.firebasestorage.app",
                "messagingSenderId": "742707673527",
                "appId": "1:742707673527:web:047b9475846fb192625032"
            },
            {
                "apiKey": "AIzaSyB5jW7Xv_xo35JDCjQ8TMmH6I2LoPt9R0U",
                "authDomain": "spartafest-light-show-1-8d747.firebaseapp.com",
                "projectId": "spartafest-light-show-1-8d747",
                "storageBucket": "spartafest-light-show-1-8d747.firebasestorage.app",
                "messagingSenderId": "164272036816",
                "appId": "1:164272036816:web:0e1670211109c90e71b7d5"
            },
            {
                "apiKey": "AIzaSyBq-v6FipVttot_W4BjOyLt98PBD9bveIE",
                "authDomain": "spartafest-light-show-2-875d2.firebaseapp.com",
                "projectId": "spartafest-light-show-2-875d2",
                "storageBucket": "spartafest-light-show-2-875d2.firebasestorage.app",
                "messagingSenderId": "4988837433",
                "appId": "1:4988837433:web:da9f1e151d39a4010037e8"
            },
            {
                "apiKey": "AIzaSyA1ZE-A7Srtwxh9fIvNTPAL-VB7cPvQCl8",
                "authDomain": "spartafest-light-show-4-24dd6.firebaseapp.com",
                "projectId": "spartafest-light-show-4-24dd6",
                "storageBucket": "spartafest-light-show-4-24dd6.firebasestorage.app",
                "messagingSenderId": "301905579354",
                "appId": "1:301905579354:web:3fab68ba3406807d02f763"
            },
            {
                "apiKey": "AIzaSyAhxRzJybECoDExbc0L5RAVF344v12sBPY",
                "authDomain": "spartafest-light-show-3-6fe77.firebaseapp.com",
                "projectId": "spartafest-light-show-3-6fe77",
                "storageBucket": "spartafest-light-show-3-6fe77.firebasestorage.app",
                "messagingSenderId": "1045129913893",
                "appId": "1:1045129913893:web:693f6b50ab6028d7b1c1cc"
            },
            {
                "apiKey": "AIzaSyBBNZtZQeVI8cTLdngWsY-ZyE-lQFVvbrY",
                "authDomain": "spartafest-light-show-5-c537c.firebaseapp.com",
                "projectId": "spartafest-light-show-5-c537c",
                "storageBucket": "spartafest-light-show-5-c537c.firebasestorage.app",
                "messagingSenderId": "1082812115992",
                "appId": "1:1082812115992:web:cd663dba4d64ad4314276d"
            },
            {
                "apiKey": "AIzaSyDo0W9148CnsjRSC8OvG4tqhJn-dV1qpeU",
                "authDomain": "spartafest-light-show-6-2f88e.firebaseapp.com",
                "projectId": "spartafest-light-show-6-2f88e",
                "storageBucket": "spartafest-light-show-6-2f88e.firebasestorage.app",
                "messagingSenderId": "552726696993",
                "appId": "1:552726696993:web:5849379796e686d1beff60"
            },
            {
                "apiKey": "AIzaSyBQMcn9M_POwD3sxb-8YlwHumCdZJcEwho",
                "authDomain": "spartafest-light-show-9-8e41c.firebaseapp.com",
                "projectId": "spartafest-light-show-9-8e41c",
                "storageBucket": "spartafest-light-show-9-8e41c.firebasestorage.app",
                "messagingSenderId": "1018692456966",
                "appId": "1:1018692456966:web:ab9f0fb0e037a68374e987"
            },
            {
                "apiKey": "AIzaSyDu2qdJJo248-xwto1dy4wHdxm4bqgBZds",
                "authDomain": "spartafest-light-show-7-6ab33.firebaseapp.com",
                "projectId": "spartafest-light-show-7-6ab33",
                "storageBucket": "spartafest-light-show-7-6ab33.firebasestorage.app",
                "messagingSenderId": "39756895336",
                "appId": "1:39756895336:web:764ed424e393556f9b57dd"
            },
            {
                "apiKey": "AIzaSyCwAslZMLzO1fv5Qv3UmWBnQIeYoQ1tIgU",
                "authDomain": "spartafest-light-show-8-30403.firebaseapp.com",
                "projectId": "spartafest-light-show-8-30403",
                "storageBucket": "spartafest-light-show-8-30403.firebasestorage.app",
                "messagingSenderId": "109135025261",
                "appId": "1:109135025261:web:4fec11be40ce8b3d275b64"
            },
            {
                "apiKey": "AIzaSyBAdy3jhCCzo6sak7bnBZvXDbLLndpFXwc",
                "authDomain": "spartafest-light-show-1-77d47.firebaseapp.com",
                "projectId": "spartafest-light-show-1-77d47",
                "storageBucket": "spartafest-light-show-1-77d47.firebasestorage.app",
                "messagingSenderId": "72308500575",
                "appId": "1:72308500575:web:7dd76263007ba7668593ea"
            },
            {
                "apiKey": "AIzaSyBb1WWJgGo8GdUt7SuZd0M_vU1D0aJZ9YA",
                "authDomain": "spartafest-light-show-3-e2de5.firebaseapp.com",
                "projectId": "spartafest-light-show-3-e2de5",
                "storageBucket": "spartafest-light-show-3-e2de5.firebasestorage.app",
                "messagingSenderId": "809522421625",
                "appId": "1:809522421625:web:53299cbc2da7bc95e7d9a8"
            },
            {
                "apiKey": "AIzaSyD-kE5q6Znk3hH05Tn-2hhRaXn0flzq5bk",
                "authDomain": "spartafest-light-show-2-f4d2b.firebaseapp.com",
                "projectId": "spartafest-light-show-2-f4d2b",
                "storageBucket": "spartafest-light-show-2-f4d2b.firebasestorage.app",
                "messagingSenderId": "535420977459",
                "appId": "1:535420977459:web:cdb58180482abff614fe46"
            },
            {
                "apiKey": "AIzaSyANr66hnmRNafkgKBNTXdqjK6EtxCkB948",
                "authDomain": "spartafest-light-show-5-bf3a7.firebaseapp.com",
                "projectId": "spartafest-light-show-5-bf3a7",
                "storageBucket": "spartafest-light-show-5-bf3a7.firebasestorage.app",
                "messagingSenderId": "591776558333",
                "appId": "1:591776558333:web:7c2d47489f4518e2f5a294"
            },
            {
                "apiKey": "AIzaSyC5Wo7pfvEPYtS96DDJZaoVai-Horp7wNw",
                "authDomain": "spartafest-light-show-4-2f6e5.firebaseapp.com",
                "projectId": "spartafest-light-show-4-2f6e5",
                "storageBucket": "spartafest-light-show-4-2f6e5.firebasestorage.app",
                "messagingSenderId": "275723495507",
                "appId": "1:275723495507:web:7fb952d460097610193ea6"
            },
            {
                "apiKey": "AIzaSyD_frbCDGk_wMJ1ANmmYtTIpUv8rlTUMxc",
                "authDomain": "spartafest-light-show-6-b6514.firebaseapp.com",
                "projectId": "spartafest-light-show-6-b6514",
                "storageBucket": "spartafest-light-show-6-b6514.firebasestorage.app",
                "messagingSenderId": "477257306730",
                "appId": "1:477257306730:web:a293d769935e97b20df013"
            },
            {
                "apiKey": "AIzaSyB4CCJbiSPgcz6w7-yUqA4hWh0NALIw2e8",
                "authDomain": "spartafest-light-show-7-1769e.firebaseapp.com",
                "projectId": "spartafest-light-show-7-1769e",
                "storageBucket": "spartafest-light-show-7-1769e.firebasestorage.app",
                "messagingSenderId": "473694478791",
                "appId": "1:473694478791:web:c2ed988aa802b218bfb9e2"
            },
            {
                "apiKey": "AIzaSyBLnzzod-__-Lx-4fbaRXQGXWd-cIoEYSk",
                "authDomain": "spartafest-light-show-9-909e9.firebaseapp.com",
                "projectId": "spartafest-light-show-9-909e9",
                "storageBucket": "spartafest-light-show-9-909e9.firebasestorage.app",
                "messagingSenderId": "121455085693",
                "appId": "1:121455085693:web:62c15ce21fe016e05a4914"
            },
            {
                "apiKey": "AIzaSyAJ9-GY6Zw-qLD5hwO6vgcCdzAJJCNOPAo",
                "authDomain": "spartafest-light-show-8-cd783.firebaseapp.com",
                "projectId": "spartafest-light-show-8-cd783",
                "storageBucket": "spartafest-light-show-8-cd783.firebasestorage.app",
                "messagingSenderId": "554354759234",
                "appId": "1:554354759234:web:289c0ad62ff7c9aad37fdb"
            },
            {
                "apiKey": "AIzaSyDZXAb9OUvwLcAMSS72-eIaBZIxaqiF6mc",
                "authDomain": "spartafest-light-show-10-244ed.firebaseapp.com",
                "projectId": "spartafest-light-show-10-244ed",
                "storageBucket": "spartafest-light-show-10-244ed.firebasestorage.app",
                "messagingSenderId": "1085232363225",
                "appId": "1:1085232363225:web:da55f89b7e7aa25b6b30c8"
            },
            {
                "apiKey": "AIzaSyCmta9DNKtDUQrVfS2jjO4sgEfV8nl2ysc",
                "authDomain": "spartafest-light-show-11-80319.firebaseapp.com",
                "projectId": "spartafest-light-show-11-80319",
                "storageBucket": "spartafest-light-show-11-80319.firebasestorage.app",
                "messagingSenderId": "600824057096",
                "appId": "1:600824057096:web:5288736d31f0c6696f70bd"
            },
            {
                "apiKey": "AIzaSyCfsrF6DpQfIbOmWgx9oGhn0r-Qo1grMHk",
                "authDomain": "spartafest-light-show-1-c1acc.firebaseapp.com",
                "projectId": "spartafest-light-show-1-c1acc",
                "storageBucket": "spartafest-light-show-1-c1acc.firebasestorage.app",
                "messagingSenderId": "786269942931",
                "appId": "1:786269942931:web:a22bdffd7c662283f5c966"
            },
            {
                "apiKey": "AIzaSyBRQiRn_zjWH98kAa-S5RX8eMUr70G9U9g",
                "authDomain": "spartafest-light-show-2-a2e39.firebaseapp.com",
                "projectId": "spartafest-light-show-2-a2e39",
                "storageBucket": "spartafest-light-show-2-a2e39.firebasestorage.app",
                "messagingSenderId": "608097081755",
                "appId": "1:608097081755:web:201addc24acd094221293e"
            },
            {
                "apiKey": "AIzaSyCCf3-b2QqK06b1COyfWLk57O6Nfly6Oeg",
                "authDomain": "spartafest-light-show-3-4e41d.firebaseapp.com",
                "projectId": "spartafest-light-show-3-4e41d",
                "storageBucket": "spartafest-light-show-3-4e41d.firebasestorage.app",
                "messagingSenderId": "12240371495",
                "appId": "1:12240371495:web:1c77d72f2964e7fd177302"
            },
            {
                "apiKey": "AIzaSyDMLY4nBU9mF9LDvM1uO0c1bEC_oouJhRE",
                "authDomain": "spartafest-light-show-4-2bfdb.firebaseapp.com",
                "projectId": "spartafest-light-show-4-2bfdb",
                "storageBucket": "spartafest-light-show-4-2bfdb.firebasestorage.app",
                "messagingSenderId": "318286877309",
                "appId": "1:318286877309:web:4086765380aa1670879714"
            },
            {
                "apiKey": "AIzaSyBzDPxNosjkDwcbJnL9LzumM7-RZWPqZv0",
                "authDomain": "spartafest-light-show-5-3f5c7.firebaseapp.com",
                "projectId": "spartafest-light-show-5-3f5c7",
                "storageBucket": "spartafest-light-show-5-3f5c7.firebasestorage.app",
                "messagingSenderId": "231344058883",
                "appId": "1:231344058883:web:26ef3477011b886e369436"
            },
            {
                "apiKey": "AIzaSyD3dobUdVaNfUZp0buFvA9mWQg3d_RjXNA",
                "authDomain": "spartafest-light-show-6-83bab.firebaseapp.com",
                "projectId": "spartafest-light-show-6-83bab",
                "storageBucket": "spartafest-light-show-6-83bab.firebasestorage.app",
                "messagingSenderId": "307894962477",
                "appId": "1:307894962477:web:6ce71b3f095412423b6ba4"
            },
            {
                "apiKey": "AIzaSyClRPU8dl7fdM1-TFQIzQYdTpHuJxbT7o4",
                "authDomain": "spartafest-light-show-7-9aecd.firebaseapp.com",
                "projectId": "spartafest-light-show-7-9aecd",
                "storageBucket": "spartafest-light-show-7-9aecd.firebasestorage.app",
                "messagingSenderId": "281450366181",
                "appId": "1:281450366181:web:b8f835932bdc8a8e1a800c"
            },
            {
                "apiKey": "AIzaSyDV0AM9K4zktQZaUyBhF8gLiHUqc-C82EE",
                "authDomain": "spartafest-light-show-8-85668.firebaseapp.com",
                "projectId": "spartafest-light-show-8-85668",
                "storageBucket": "spartafest-light-show-8-85668.firebasestorage.app",
                "messagingSenderId": "406168936659",
                "appId": "1:406168936659:web:14480441d906c3255e7426"
            },
            {
                "apiKey": "AIzaSyDZVAz5hPNY6JYJNpADuh-XVHUxEPz33LE",
                "authDomain": "spartafest-light-show-9-f81de.firebaseapp.com",
                "projectId": "spartafest-light-show-9-f81de",
                "storageBucket": "spartafest-light-show-9-f81de.firebasestorage.app",
                "messagingSenderId": "211314006572",
                "appId": "1:211314006572:web:3a8fd220755ccf54c60f89"
            },
            {
                "apiKey": "AIzaSyDomDWAG2zpO0BvBRWXiK1j97yiSy-396Y",
                "authDomain": "spartafest-light-show-10-e7c1c.firebaseapp.com",
                "projectId": "spartafest-light-show-10-e7c1c",
                "storageBucket": "spartafest-light-show-10-e7c1c.firebasestorage.app",
                "messagingSenderId": "847889080683",
                "appId": "1:847889080683:web:a6356177dfe6feafd52c2e"
            },
            {
                "apiKey": "AIzaSyBUUuNR_ONxv_D-nFzqqwn93govNyagFZI",
                "authDomain": "spartafest-light-show-2-1c5a2.firebaseapp.com",
                "projectId": "spartafest-light-show-2-1c5a2",
                "storageBucket": "spartafest-light-show-2-1c5a2.firebasestorage.app",
                "messagingSenderId": "255608691346",
                "appId": "1:255608691346:web:508d50c63b91339400644b"
            },
            {
                "apiKey": "AIzaSyCFPtkxKyyVBxSbPOSBwDSzPQwIkRrccCU",
                "authDomain": "spartafest-light-show-2-d9b72.firebaseapp.com",
                "projectId": "spartafest-light-show-2-d9b72",
                "storageBucket": "spartafest-light-show-2-d9b72.firebasestorage.app",
                "messagingSenderId": "498521151305",
                "appId": "1:498521151305:web:6139469a9f583446d16c98"
            },
            {
                "apiKey": "AIzaSyCnYO9Rt1uZbKrH1mEbHkPwtCdJXVWxyRY",
                "authDomain": "spartafest-light-show-4-f27d6.firebaseapp.com",
                "projectId": "spartafest-light-show-4-f27d6",
                "storageBucket": "spartafest-light-show-4-f27d6.firebasestorage.app",
                "messagingSenderId": "916591661161",
                "appId": "1:916591661161:web:3421d18ed1699d2f93d2f8"
            },
            {
                "apiKey": "AIzaSyC5MndnjAbCcU4jWPR7L998gr9Rde0U0ug",
                "authDomain": "spartafest-light-show-5-be1f6.firebaseapp.com",
                "projectId": "spartafest-light-show-5-be1f6",
                "storageBucket": "spartafest-light-show-5-be1f6.firebasestorage.app",
                "messagingSenderId": "655177381425",
                "appId": "1:655177381425:web:81e7880fe1eb675574c710"
            },
            {
                "apiKey": "AIzaSyDlHjgS2XleMMmLAF_h6ofMpg4BJo_CQ8w",
                "authDomain": "spartafest-light-show-6-44d06.firebaseapp.com",
                "projectId": "spartafest-light-show-6-44d06",
                "storageBucket": "spartafest-light-show-6-44d06.firebasestorage.app",
                "messagingSenderId": "283171319030",
                "appId": "1:283171319030:web:8eedec7714e3cc87ec50d7"
            },
            {
                "apiKey": "AIzaSyB1v4PSI9OxfHJYhPoVM0_Qh0uxDNzCMXE",
                "authDomain": "spartafest-light-show-7-588d2.firebaseapp.com",
                "projectId": "spartafest-light-show-7-588d2",
                "storageBucket": "spartafest-light-show-7-588d2.firebasestorage.app",
                "messagingSenderId": "251984493726",
                "appId": "1:251984493726:web:657169f2e496e08402cf8f"
            },
            {
                "apiKey": "AIzaSyDTx7NhXeAvCnREgIfZydBYf3UzBdomobY",
                "authDomain": "spartafest-light-show-8-b5864.firebaseapp.com",
                "projectId": "spartafest-light-show-8-b5864",
                "storageBucket": "spartafest-light-show-8-b5864.firebasestorage.app",
                "messagingSenderId": "1015093600448",
                "appId": "1:1015093600448:web:7a10c631e23f5a9aed0d25"
            },
            {
                "apiKey": "AIzaSyAlVUb62yYv_1QeQIzZlebcxWWCXDXyZ3I",
                "authDomain": "spartafest-light-show-9-da49a.firebaseapp.com",
                "projectId": "spartafest-light-show-9-da49a",
                "storageBucket": "spartafest-light-show-9-da49a.firebasestorage.app",
                "messagingSenderId": "826217860966",
                "appId": "1:826217860966:web:368203a98f7e07b2bc82a7"
            },
            {
                "apiKey": "AIzaSyA-NcX93vKatTIPCpi4XT8ZdZkqr-mrvqg",
                "authDomain": "spartafest-light-show-10-7c6bf.firebaseapp.com",
                "projectId": "spartafest-light-show-10-7c6bf",
                "storageBucket": "spartafest-light-show-10-7c6bf.firebasestorage.app",
                "messagingSenderId": "987866528154",
                "appId": "1:987866528154:web:4a279dbdd9d7b773832223"
            },
            {
                "apiKey": "AIzaSyARB-o4CvM6cpZtXNICxGO1nEl43x9ZydE",
                "authDomain": "spartafest-light-show-11-4916a.firebaseapp.com",
                "projectId": "spartafest-light-show-11-4916a",
                "storageBucket": "spartafest-light-show-11-4916a.firebasestorage.app",
                "messagingSenderId": "906888421105",
                "appId": "1:906888421105:web:b4d911ed1036727c82d350"
            }
        ];

        const workingIndexes = Array.from({ length: 82 }, (_, i) => i); // 82 shards
        const brokenIndexes = [];

        const firebaseApps = firebaseConfigs.map((config, index) => {
            try {
                return index === 0 ? firebase.initializeApp(config) : firebase.initializeApp(config, `app${index}`);
            } catch (err) {
                console.error(`❌ Firebase app ${index + 1} failed to initialize`, err);
                brokenIndexes.push(index);
                return null;
            }
        });

        function getOrCreateDeviceId() {
            let uid = localStorage.getItem('deviceUID');
            if (!uid) {
                uid = 'LED_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceUID', uid);
            }
            return uid;
        }

        function getUserDb() {
            const uid = getOrCreateDeviceId();
            const numericId = uid.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
            const dbIndex = Math.floor(numericId / 75); // 75 users per Firestore shard across 82 DBs (6150 users total)

            if (!workingIndexes.includes(dbIndex)) {
                console.warn(`⚠️ DB index ${dbIndex} not working. Falling back.`);
                const fallback = workingIndexes[0];
                const fallbackApp = fallback === 0 ? firebase.app() : firebase.app(`app${fallback}`);
                return fallbackApp.firestore();
            }

            const app = dbIndex === 0 ? firebase.app() : firebase.app(`app${dbIndex}`);
            return app.firestore();
        }

        // Usage
        const db = getUserDb();
        
        // DOM elements
        const standbyScreen = document.getElementById('standbyScreen');
        const lightScreen = document.getElementById('lightScreen');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const loadingMessage = document.getElementById('loadingMessage');
        const deviceInfo = document.getElementById('deviceInfo');
        const deviceId = document.getElementById('deviceId');
        const lastUpdate = document.getElementById('lastUpdate');
        const effectIndicator = document.getElementById('effectIndicator');
        const currentEffect = document.getElementById('currentEffect');
        const patternLights = document.getElementById('patternLights');
        const light1 = document.getElementById('light1');
        const light2 = document.getElementById('light2');
        const light3 = document.getElementById('light3');
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        function isLowBandwidth() {
            return connection && (connection.saveData || /2g/.test(connection.effectiveType));
        }
        const shardCount = 10;
        let userShardIndex = parseInt(localStorage.getItem('shardIndex')) || Math.floor(Math.random() * shardCount);
        localStorage.setItem('shardIndex', userShardIndex);  // persist
        const userShardDoc = `shard_${userShardIndex}`;
        let currentListener = null;
        let animationTimeouts = [];
        let lastAppliedCommand = null;
        try {
        const saved = localStorage.getItem('lastCommand');
        if (saved) {
            lastAppliedCommand = JSON.parse(saved);
            applyLightEffect(lastAppliedCommand);
        }
        } catch (e) {
        console.warn('Failed to parse saved command.');
        }
        let deviceUID = generateDeviceId();
        let currentState = {
            color: '#000000',
            effect: 'solid',
            intensity: 1,
            speed: 1
        };
        
        let infoHideTimeout;

        function scheduleInfoAutoHide() {
            clearTimeout(infoHideTimeout);
            infoHideTimeout = setTimeout(() => {
                document.getElementById('status').classList.add('hidden');
                document.getElementById('deviceInfo').classList.add('hidden');
            }, 5000);
        }

        function showInfoBoxes() {
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('deviceInfo').classList.remove('hidden');
            scheduleInfoAutoHide();
        }

        // Start timer on load
        document.addEventListener('DOMContentLoaded', () => {
            scheduleInfoAutoHide();
        });

        // Re-show on touch or click
        document.addEventListener('touchstart', showInfoBoxes, { passive: true });
        document.addEventListener('click', showInfoBoxes);

        // Generate unique device ID
        function generateDeviceId() {
            const stored = localStorage.getItem('deviceUID');
            if (stored) return stored;
            
            const uid = 'LED_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceUID', uid);
            return uid;
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.classList.add('connected');
                statusText.textContent = 'Connected';
                loadingMessage.style.display = 'none';
            } else {
                connectionStatus.classList.remove('connected');
                statusText.textContent = 'Reconnecting...';
                loadingMessage.style.display = 'block';
            }
        }
        
        // Update the user count by a delta (positive or negative)
        function updateUserCount(delta) {
            const ref = db.collection('system').doc('userCount');

            db.runTransaction(async (transaction) => {
                const doc = await transaction.get(ref);
                const current = doc.exists ? doc.data().count || 0 : 0;
                transaction.set(ref, { count: current + delta }, { merge: true });
            }).catch((err) => {
                console.error('Failed to update user count:', err);
            });
        }

        // Clear all animations and timeouts
        function clearAllEffects() {
            lightScreen.className = '';
            patternLights.style.display = 'none';
            
            // Clear pattern light classes
            [light1, light2, light3].forEach(light => {
                light.className = 'pattern-light';
            });
            
            // Clear timeouts
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            animationTimeouts = [];
        }
        
        // Apply pattern effect
        function applyPatternEffect(patternData, speed = 1) {
            patternLights.style.display = 'none';
            lightScreen.style.background = '#000';

            const colors = patternData.colors || ['#ff0000', '#00ff00', '#0000ff'];
            let colorIndex = 0;

            function showNextColor() {
                const color = colors[colorIndex % colors.length];
                lightScreen.style.background = color;
                lightScreen.style.opacity = patternData.intensity || 1;

                colorIndex++;
                const timeout = setTimeout(showNextColor, 600 / speed);
                animationTimeouts.push(timeout);
            }

            showNextColor();
        }
        
        // Apply light effect
        function applyLightEffect(data) {
            const { 
                color = '#000000', 
                effect = 'standby', 
                intensity = 1, 
                speed = 1, 
                pattern = null,
                type = 'normal'
            } = data;
            localStorage.setItem('lastCommand', JSON.stringify(data));
            clearAllEffects();

            // Update current state
            currentState = { color, effect, intensity, speed };
            
            // 🟡 Handle Standby Mode First
            if (effect === 'standby') {
                standbyScreen.style.display = 'flex';
                patternLights.style.display = 'none';
                lightScreen.style.background = '#000';
                effectIndicator.classList.remove('visible');
                return;
            } else {
                standbyScreen.style.display = 'none';
            }

            // Update effect indicator
            currentEffect.textContent = effect.charAt(0).toUpperCase() + effect.slice(1);
            effectIndicator.classList.add('visible');
            setTimeout(() => effectIndicator.classList.remove('visible'), 3000);
            
            // Handle emergency stop
            if (type === 'emergency') {
                lightScreen.classList.add('emergency');
                return;
            }
            
            // Handle pattern effect
            if (effect === 'pattern' && pattern) {
                applyPatternEffect(pattern, speed);
                return;
            }
            
            // Standard single-screen effects
            patternLights.style.display = 'none';
            lightScreen.style.background = color;
            lightScreen.style.opacity = intensity;
            
            // Apply animation effects
            switch (effect) {
                case 'strobe':
                    lightScreen.classList.add('strobe');
                    lightScreen.style.animationDuration = (0.1 / speed) + 's';
                    break;
                    
                case 'pulse':
                    lightScreen.classList.add('pulse');
                    lightScreen.style.animationDuration = (1 / speed) + 's';
                    break;
                    
                case 'fade':
                    lightScreen.classList.add('fade');
                    lightScreen.style.animationDuration = (2 / speed) + 's';
                    break;
                    
                case 'wave':
                    lightScreen.classList.add('wave');
                    lightScreen.style.animationDuration = (1.5 / speed) + 's';
                    break;
                    
                case 'rainbow':
                    lightScreen.classList.add('rainbow');
                    lightScreen.style.animationDuration = (3 / speed) + 's';
                    break;
                    
                case 'flash':
                    lightScreen.classList.add('flash');
                    lightScreen.style.animationDuration = (0.3 / speed) + 's';
                    break;
                    
                default:
                    // Solid color - no animation
                    break;
            }
        }
        
        // Listen for real-time updates from admin
        function startShardListener() {
            try {
                currentListener = db.collection('commands_sharded')
                    .doc(userShardDoc)
                    .onSnapshot((doc) => {
                        updateConnectionStatus(true);
                        lastUpdate.textContent = new Date().toLocaleTimeString();

                        if (doc.exists) {
                            const data = doc.data();
                            console.log('📥 Received sharded command:', data);
                            applyLightEffect(data);
                        }
                    }, (error) => {
                        console.error('⚠️ Shard listener error:', error);
                        updateConnectionStatus(false);
                        setTimeout(startShardListener, 3000);
                    });
            } catch (error) {
                console.error('❌ Failed to start shard listener:', error);
                updateConnectionStatus(false);
                setTimeout(startShardListener, 3000);
            }
        }
        
        // Initialize device info
        function initDeviceInfo() {
            deviceId.textContent = deviceUID;
        }

        // Create a user in Firestore if not already present
        function createUserIfNotExists() {
            const userRef = db.collection('users').doc(deviceUID);

            userRef.get().then((doc) => {
                if (!doc.exists) {
                    userRef.set({
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log('✅ New user added to Firestore');
                        updateUserCount(1);
                    });
                } else {
                    console.log('ℹ️ User already exists:', deviceUID);
                    // Don't change user count if user already exists
                }
            }).catch((err) => {
                console.error('Failed to check or create user:', err);
            });
        }
        
        // Initialize app
        function init() {
            console.log('Initializing LED Light User App...');
            console.log('Device ID:', deviceUID);
            createUserIfNotExists();
            initDeviceInfo();
            startShardListener();
            
            // Keep screen awake (request)
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(err => {
                    console.log('Wake lock failed:', err);
                });
            }
            
            // Prevent screen from going to sleep on mobile
            document.addEventListener('touchstart', function() {}, {passive: true});
        }
        
        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Optimize Firestore reads by pausing listener when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (currentListener) {
                    currentListener();  // stop Firestore listener
                    currentListener = null;
                    console.log('🔌 Listener paused (tab hidden)');
                }
            } else {
                console.log('🔌 Resuming listener (tab visible)');
                startShardListener();
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            console.log('Device back online');
            startShardListener();
        });
        
        window.addEventListener('offline', () => {
            console.log('Device offline');
            updateConnectionStatus(false);
        });
        
        // Error handling for uncaught errors
        window.addEventListener('error', (event) => {
            console.error('Application error:', event.error);
            updateConnectionStatus(false);
        });
        
        console.log('🎭 Event LED User Interface Loaded');
    </script>
</body>
</html>